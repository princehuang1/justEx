import React, { useState, useEffect } from 'react';
import { useNavigate, useParams, useLocation } from 'react-router-dom';
import axios from 'axios';
import Navbar from '../components/Navbar';
import SeatSelector from '../components/SeatSelector';

function BookingConfirmationPage() {
  const navigate = useNavigate();
  const { movieId } = useParams();
  const location = useLocation();

  // 1. æ¥æ”¶å¾ä¸Šä¸€é  (MovieDetailPage) å‚³ä¾†çš„è³‡æ–™
  // å¦‚æœæ²’æœ‰è³‡æ–™ (ä¾‹å¦‚ç›´æ¥è¼¸å…¥ç¶²å€é€²å…¥)ï¼Œå‰‡ä½¿ç”¨é è¨­ç©ºå€¼ä»¥é˜²å ±éŒ¯
  const bookingData = location.state || {
    tickets: [], // { name, price, count }
    meals: [],   // { name, price, count }
    theatre: { name: 'æœªé¸æ“‡å½±åŸ' },
    date: { dayName: '', dayNum: '' },
    time: ''
  };

  const [movie, setMovie] = useState(null);
  const [selectedSeats, setSelectedSeats] = useState([]);
  const [isConfirmed, setIsConfirmed] = useState(false);

  // 2. æŠ“å–é›»å½±è³‡æ–™ (ç‚ºäº†é¡¯ç¤ºç‰‡å)
  useEffect(() => {
    axios.get(`http://localhost:4000/api/movies/${movieId}`)
      .then(res => setMovie(res.data))
      .catch(err => console.error("ç„¡æ³•æŠ“å–é›»å½±è³‡æ–™", err));
  }, [movieId]);

  // 3. è¨ˆç®—ç¸½é‡‘é¡ (ç¥¨åƒ¹ + é¤é»)
  const calculateTotal = () => {
    const ticketsTotal = bookingData.tickets.reduce((sum, item) => sum + (item.price * item.count), 0);
    const mealsTotal = bookingData.meals.reduce((sum, item) => sum + (item.price * item.count), 0);
    return ticketsTotal + mealsTotal;
  };

  // 4. è¨ˆç®—ç¸½ç¥¨æ•¸ (ç”¨ä¾†æª¢æŸ¥åº§ä½æ•¸æ˜¯å¦æ­£ç¢º)
  const totalTicketsCount = bookingData.tickets.reduce((sum, item) => sum + item.count, 0);

  // æŒ‰éˆ•é‚è¼¯ï¼šå–æ¶ˆ
  const handleCancel = () => {
    if (isConfirmed) {
      setIsConfirmed(false); // å¦‚æœå·²ç¢ºèªï¼Œå–æ¶ˆå‰‡å›åˆ°é¸ä½ç‹€æ…‹
    } else {
      navigate(-1); // è¿”å›ä¸Šä¸€é 
    }
  };

  // æŒ‰éˆ•é‚è¼¯ï¼šç¢ºèª / ä»˜æ¬¾
  const handleConfirm = () => {
    // æª¢æŸ¥åº§ä½æ•¸æ˜¯å¦ç­‰æ–¼ç¥¨æ•¸ (å¦‚æœä¸Šä¸€é æœ‰é¸ç¥¨çš„è©±)
    if (totalTicketsCount > 0 && selectedSeats.length !== totalTicketsCount) {
      alert(`æ‚¨è³¼è²·äº† ${totalTicketsCount} å¼µç¥¨ï¼Œè«‹é¸æ“‡ ${totalTicketsCount} å€‹åº§ä½ã€‚`);
      return;
    }
    if (selectedSeats.length === 0 && totalTicketsCount === 0) {
        // å¦‚æœå®Œå…¨æ²’é¸ç¥¨ä¹Ÿæ²’é¸ä½(æ¥µç«¯æƒ…æ³)ï¼Œè‡³å°‘è¦é¸ä¸€å€‹ä½å­
         if (selectedSeats.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åº§ä½");
            return;
         }
    }


    if (!isConfirmed) {
      setIsConfirmed(true); // ç¬¬ä¸€æ¬¡é»æ“Šï¼šé–å®šä¸¦é¡¯ç¤ºæ˜ç´°
    } else {
      alert("è¨‚å–®å·²é€å‡ºï¼é€²å…¥ä»˜æ¬¾æµç¨‹..."); // ç¬¬äºŒæ¬¡é»æ“Šï¼šä»˜æ¬¾
      // navigate('/payment', { state: { ...bookingData, seats: selectedSeats, total: calculateTotal() } });
    }
  };

  // å¦‚æœæ²’æœ‰å¾ä¸Šä¸€é å‚³ä¾†è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º (é–‹ç™¼é™¤éŒ¯ç”¨)
  if (!location.state) {
    console.warn("è­¦å‘Šï¼šæ­¤é é¢æ²’æœ‰æ¥æ”¶åˆ° bookingDataï¼Œå¯èƒ½æ˜¯ç›´æ¥è¼¸å…¥ç¶²å€é€²å…¥çš„ã€‚");
  }

  return (
    <div className="min-h-screen bg-neutral-900 text-gray-100 font-sans flex flex-col">
      <Navbar />
      
      <main className="flex-grow container mx-auto px-20 py-8 flex flex-col items-center justify-center">
        
        <h1 className="text-4xl font-bold text-white mb-2">é¸æ“‡åº§ä½</h1>
        {movie && <p className="text-gray-400 mb-8">{movie.movieName} | {bookingData.theatre.name}</p>}
        
        {/* åº§ä½é¸æ“‡å™¨ */}
        <div className={`w-full max-w-4xl transition-all duration-500 ${isConfirmed ? 'opacity-80 pointer-events-none' : ''}`}>
          <SeatSelector 
             selectedSeats={selectedSeats}
             onSeatSelect={setSelectedSeats}
          />
        </div>

        {/* ğŸ¯ è¨‚å–®è³‡è¨Šå€å¡Š (ç¢ºèªå¾Œé¡¯ç¤º) */}
        {isConfirmed && (
          <div className="w-full max-w-4xl mt-8 bg-neutral-800 p-8 rounded-xl shadow-lg border border-purple-500/30 animate-fade-in-up">
            <h2 className="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-4">è¨‚å–®ç¢ºèª</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              
              {/* å·¦å´ï¼šæ˜ç´°åˆ—è¡¨ */}
              <div className="space-y-4">
                {/* é¡¯ç¤ºå½±åŸèˆ‡æ™‚é–“ */}
                <div className="pb-2 border-b border-gray-700">
                    <p className="text-purple-400 font-semibold">å ´æ¬¡è³‡è¨Š</p>
                    <p className="text-gray-300">{bookingData.theatre.name}</p>
                    <p className="text-gray-300">{bookingData.date.dayNum}æ—¥ ({bookingData.date.dayName})</p>
                </div>

                {/* é¡¯ç¤ºç¥¨ç¨® */}
                {bookingData.tickets.length > 0 && (
                    <div>
                        <p className="text-purple-400 font-semibold">é›»å½±ç¥¨</p>
                        {bookingData.tickets.map((t, i) => (
                            t.count > 0 && (
                                <div key={i} className="flex justify-between text-gray-300">
                                    <span>{t.name} x{t.count}</span>
                                    <span>$ {t.price * t.count}</span>
                                </div>
                            )
                        ))}
                    </div>
                )}

                {/* é¡¯ç¤ºé¤é» */}
                {bookingData.meals.length > 0 && (
                    <div>
                        <p className="text-purple-400 font-semibold">é¤é£²</p>
                        {bookingData.meals.map((m, i) => (
                             m.count > 0 && (
                                <div key={i} className="flex justify-between text-gray-300">
                                    <span>{m.name} x{m.count}</span>
                                    <span>$ {m.price * m.count}</span>
                                </div>
                            )
                        ))}
                    </div>
                )}
              </div>

              {/* å³å´ï¼šåº§ä½èˆ‡ç¸½è¨ˆ */}
              <div className="flex flex-col justify-between">
                <div>
                  <h3 className="text-purple-400 font-semibold mb-2">å·²é¸åº§ä½</h3>
                  <div className="flex flex-wrap gap-2">
                    {selectedSeats.length > 0 ? (
                        selectedSeats.map(seat => (
                        <span key={seat} className="bg-purple-900 text-purple-100 px-3 py-1 rounded-md text-sm font-bold">
                            {seat}
                        </span>
                        ))
                    ) : (
                        <span className="text-gray-500">æœªé¸æ“‡</span>
                    )}
                  </div>
                </div>
                
                <div className="mt-8 pt-4 border-t border-gray-700 flex justify-between items-end">
                  <span className="text-gray-400">ç¸½é‡‘é¡</span>
                  <span className="text-4xl font-bold text-white">$ {calculateTotal()}</span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* åº•éƒ¨æŒ‰éˆ•å€å¡Š */}
        <div className="w-full max-w-4xl flex justify-between items-center mt-12 pb-12">
            {/* å·¦ä¸‹è§’ï¼šå–æ¶ˆæŒ‰éˆ• */}
            <button 
                onClick={handleCancel}
                className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-10 rounded-full transition duration-300 text-lg"
            >
                {isConfirmed ? "ä¿®æ”¹åº§ä½" : "å–æ¶ˆ"}
            </button>

            {/* å³ä¸‹è§’ï¼šç¢ºèª/ä»˜æ¬¾æŒ‰éˆ• */}
            <button 
                onClick={handleConfirm}
                className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-10 rounded-full transition duration-300 text-lg shadow-lg hover:shadow-purple-500/50"
            >
                {isConfirmed ? "é€²è¡Œä»˜æ¬¾" : "ç¢ºèª"}
            </button>
        </div>

      </main>
    </div>
  );
}

export default BookingConfirmationPage;


